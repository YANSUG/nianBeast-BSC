<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¨ ç ²è½Ÿå¹´ç¸ï¼šæ±ºæˆ°åˆäº” (V7)</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #FFD700;
            --red: #D90429;
            --dark-red: #2b0505;
            --bg-gradient: radial-gradient(circle at center, #4a0000 0%, #1a0000 100%);
            --glass: rgba(0, 0, 0, 0.6);
            --border: 1px solid rgba(255, 215, 0, 0.3);
        }

        body {
            background: var(--bg-gradient);
            color: var(--gold);
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 2px solid var(--red);
            box-shadow: 0 0 60px rgba(217, 4, 41, 0.2);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        /* æ¨™é¡Œå€ */
        header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }
        h1 { margin: 0; font-size: 28px; text-shadow: 0 0 15px var(--red); letter-spacing: 2px; }
        .subtitle { color: #aaa; font-size: 13px; margin-top: 5px; line-height: 1.5; }
        .highlight { color: #00FFFF; font-weight: bold; }
        
        /* æŒ‰éˆ•å…±ç”¨æ¨£å¼ */
        button { font-family: 'Noto Sans TC', sans-serif; transition: all 0.3s ease; }
        .rules-btn {
            background: rgba(255, 215, 0, 0.1); border: 1px solid var(--gold); color: var(--gold);
            padding: 6px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-top: 10px;
        }
        .rules-btn:hover { background: var(--gold); color: #000; }

        /* Boss å€å¡Š (æ ¸å¿ƒ) */
        .boss-card {
            background: linear-gradient(135deg, #3a0000 0%, #150000 100%);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            position: relative;
            margin-bottom: 25px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
        }
        
        /* çµ‚å±€æ¨¡å¼ç‰¹æ•ˆ */
        .boss-card.endgame-mode {
            border-color: #FF0000;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4), inset 0 0 30px rgba(50, 0, 0, 0.8);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border { 0% { border-color: #ff0000; } 50% { border-color: #ff8800; } 100% { border-color: #ff0000; } }

        .pool-title { font-size: 14px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .pool-val { font-family: 'Roboto Mono', monospace; font-size: 36px; font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); margin: 5px 0 15px 0; }

        /* è¨ˆæ™‚å™¨ */
        .timers-row { display: flex; gap: 10px; justify-content: center; }
        .timer-badge {
            background: rgba(0,0,0,0.6); border: 1px solid #555; padding: 8px 12px; border-radius: 8px; flex: 1;
        }
        .timer-badge.hard { border-color: #00FFFF; color: #00FFFF; }
        .timer-badge.soft { border-color: #FF4444; color: #FF4444; }
        .t-label { font-size: 10px; display: block; opacity: 0.8; margin-bottom: 2px; }
        .t-val { font-family: 'Roboto Mono', monospace; font-size: 18px; font-weight: bold; }

        .last-hit { margin-top: 15px; font-size: 13px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 20px; }

        /* æ”»æ“Šå€å¡Š */
        .attack-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* é è¨­å…©æ¬„ */
            gap: 15px;
            margin-bottom: 25px;
            transition: all 0.5s ease; /* ç‰ˆé¢åˆ‡æ›å‹•ç•« */
        }
        
        /* çµ‚å±€æ¨¡å¼ï¼šè®Šç‚ºå–®æ¬„ï¼Œä¸”åªé¡¯ç¤ºå”¯ä¸€æŒ‰éˆ• */
        .attack-grid.single-mode {
            grid-template-columns: 1fr;
        }

        .atk-btn {
            background: linear-gradient(180deg, #444, #222);
            border: 1px solid #666;
            color: #fff;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .atk-btn:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .atk-btn:active { transform: scale(0.98); }

        /* 0.01 BNB ç‰¹æ•ˆæŒ‰éˆ• (çµ‚å±€ç”¨) */
        .atk-btn.special-mode {
            background: linear-gradient(135deg, #D90429 0%, #8d0801 100%);
            border: 2px solid #FFD700;
            box-shadow: 0 0 20px rgba(217, 4, 41, 0.4);
            grid-column: 1 / -1; /* å¼·åˆ¶è·¨æ»¿æ•´è¡Œ */
            padding: 25px; /* åŠ å¤§ */
        }
        .atk-btn.special-mode .cost { font-size: 28px; color: #FFD700; }
        .atk-btn.special-mode .desc { font-size: 16px; color: #fff; font-weight: bold; }

        .cost { font-size: 18px; font-weight: bold; font-family: 'Roboto Mono'; }
        .desc { font-size: 12px; margin-top: 4px; color: #aaa; }

        /* æ•¸æ“šèˆ‡åˆ†ç´… */
        .stats-panel { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #ccc; }
        .stat-val { color: var(--gold); font-family: 'Roboto Mono'; }

        .claim-btn {
            width: 100%; background: linear-gradient(90deg, #FFD700, #FFA500);
            border: none; color: #4a0000; font-weight: bold; font-size: 16px;
            padding: 12px; border-radius: 50px; cursor: pointer;
        }
        .claim-btn:hover { filter: brightness(1.1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }

        /* åº•éƒ¨æ“ä½œ */
        .footer-actions { text-align: center; margin-top: 20px; }
        #connectBtn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 10px 25px; border-radius: 30px; cursor: pointer;
        }
        
        .settle-btn {
            width: 100%; background: #06d6a0; color: #000; font-weight: bold; border: none;
            padding: 15px; border-radius: 12px; font-size: 18px; cursor: pointer;
            animation: pulse-green 2s infinite; margin-top: 10px;
            display: none; /* é è¨­éš±è— */
        }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(6, 214, 160, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(6, 214, 160, 0); } 100% { box-shadow: 0 0 0 0 rgba(6, 214, 160, 0); } }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            position: absolute; top: 10px; right: 10px;
            background: #FF0000; color: #fff; font-size: 11px; padding: 4px 8px;
            border-radius: 4px; display: none; font-weight: bold;
            box-shadow: 0 0 10px #FF0000;
        }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .modal-content { background: #222; border: 1px solid var(--gold); margin: 10% auto; padding: 25px; width: 85%; max-width: 450px; border-radius: 15px; text-align: left; color: #eee; position: relative;}
        .close { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #aaa; }
        .rule-row { margin-bottom: 12px; font-size: 14px; line-height: 1.5; border-bottom: 1px solid #333; padding-bottom: 8px; }

        /* Owner Panel */
        .admin-panel { margin-top: 20px; padding: 10px; border: 1px dashed #555; display: none; text-align: center; }
        .fuse-btn { background: #500; color: #fff; border: 1px solid red; padding: 5px 15px; cursor: pointer; border-radius: 4px; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ§¨ ç ²è½Ÿå¹´ç¸ V7</h1>
        <div class="subtitle">
            æ“Šæ®ºè€…å¾— 80% çæ± <br>
            <span class="highlight">å¼·åˆ¶é–‹å·¥æ—¥</span> è§¸ç™¼ 60% å…¨ç¶²ç´…åŒ…
        </div>
        <button class="rules-btn" onclick="openModal()">ğŸ“œ è¦å‰‡èªªæ˜</button>
    </header>

    <div class="boss-card" id="bossCard">
        <div id="endgameBadge" class="status-badge">ğŸ§§ çµ‚å±€æ¨¡å¼å•Ÿå‹•</div>
        
        <div class="pool-title">ç•¶å‰ç´¯ç©çæ± </div>
        <div class="pool-val"><span id="poolBalance">0.0000</span> <span style="font-size:16px">BNB</span></div>

        <div class="timers-row">
            <div class="timer-badge soft">
                <span class="t-label">ğŸ”¥ æˆ°é¬¥å€’æ•¸ (é‡ç½®)</span>
                <span class="t-val" id="softTimer">--:--:--</span>
            </div>
            <div class="timer-badge hard">
                <span class="t-label">ğŸ“… å¼·åˆ¶é–‹å·¥ (å›ºå®š)</span>
                <span class="t-val" id="hardTimer">--:--:--</span>
            </div>
        </div>

        <div class="last-hit">
            âš”ï¸ ä¸Šä¸€ä½å‹‡è€…: <span id="lastAttacker" style="color:#00FFFF; font-family:monospace">---</span>
        </div>
    </div>

    <div class="attack-grid" id="attackGrid">
        <button class="atk-btn" id="btn_0001" onclick="attack('0.001')">
            <span class="cost">0.001 BNB</span>
            <span class="desc">é‡ç½® 1 å°æ™‚</span>
        </button>
        
        <button class="atk-btn" id="btn_001" onclick="attack('0.01')">
            <span class="cost">0.01 BNB</span>
            <span class="desc" id="desc_001">é‡ç½® 30 åˆ†é˜</span>
        </button>

        <button class="atk-btn" id="btn_01" onclick="attack('0.1')">
            <span class="cost">0.1 BNB</span>
            <span class="desc">é‡ç½® 15 åˆ†é˜</span>
        </button>

        <button class="atk-btn" id="btn_1" onclick="attack('1')">
            <span class="cost">1 BNB</span>
            <span class="desc">é‡ç½® 5 åˆ†é˜</span>
        </button>
    </div>

    <button id="settleBtn" class="settle-btn" onclick="settleGame()">ğŸ† æ™‚é–“åˆ°ï¼ç™¼æ”¾çé‡‘èˆ‡ç´…åŒ…</button>

    <div class="stats-panel">
        <div class="stat-row">
            <span>ğŸ‘› éŒ¢åŒ…é¤˜é¡</span>
            <span class="stat-val" id="myWallet">---</span>
        </div>
        <div class="stat-row">
            <span>ğŸ’° ç´¯ç©ä»½é¡ (Shares)</span>
            <span class="stat-val" id="myShares">0.000</span>
        </div>
        <div class="stat-row">
            <span>ğŸ’ å¾…é ˜åˆ†ç´…</span>
            <span class="stat-val" id="myDividends" style="color:#00FF00; font-weight:bold;">0.0000</span>
        </div>
        <button class="claim-btn" onclick="claim()">é ˜å–åˆ†ç´… (Claim)</button>
    </div>

    <div class="footer-actions">
        <button id="connectBtn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ…</button>
    </div>

    <div id="adminPanel" class="admin-panel">
        <button class="fuse-btn" onclick="triggerFuse()">â˜ ï¸ å•Ÿå‹•ä¿éšªçµ²</button>
    </div>
</div>

<div id="rulesModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 style="color:var(--gold); margin-top:0;">ğŸ“œ éŠæˆ²è¦å‰‡ (V7)</h3>
        <div class="rule-row">1. <strong>æ¶å°¾åˆ€</strong>ï¼šå€’æ•¸çµæŸå‰çš„æœ€å¾Œæ”»æ“Šè€…ï¼Œç²å¾— <strong>80%</strong> çæ± ã€‚</div>
        <div class="rule-row">2. <strong>å¼·åˆ¶é–‹å·¥</strong>ï¼šè‹¥åˆ°é”è¾²æ›†åˆäº” 12:00ï¼Œè§¸ç™¼ <strong>60% å…¨ç¶²å¤§ç´…åŒ…</strong> (è´å®¶æ‹¿20%)ã€‚</div>
        <div class="rule-row">3. <strong>çµ‚å±€æ¨¡å¼ (Endgame)</strong>ï¼š
            <br>å‰© 6 å¤©ï¼šé™ 0.01 BNB (é‡ç½® 20åˆ†)
            <br>å‰© 5 å¤©ï¼šé™ 0.01 BNB (é‡ç½® 15åˆ†)
            <br>å‰© 3 å¤©ï¼šé™ 0.01 BNB (é‡ç½® 10åˆ†)
            <br>å‰© 24Hï¼šé™ 0.01 BNB (é‡ç½® 5åˆ†)
            <br>å‰© 60åˆ†ï¼šé™ 0.01 BNB (é‡ç½® 60ç§’)
        </div>
    </div>
</div>

<script>
    // âœ… æ–°çš„ V7 åˆç´„åœ°å€
    const CONTRACT_ADDR = "0x5D568c438Fc8637F01fB09293aaB481A4fA607d7";
    
    const ABI = [
        "function attack() external payable",
        "function settleGame() external",
        "function claimDividend() external",
        "function triggerFuse() external",
        "function nianHp() view returns (uint256)",
        "function lastAttacker() view returns (address)",
        "function getPendingDividend(address) view returns (uint256)",
        "function players(address) view returns (uint256, uint256, uint256)",
        "function isGameOver() view returns (bool)",
        "function owner() view returns (address)",
        "function deadline() view returns (uint256)",
        "function hardDeadline() view returns (uint256)"
    ];

    let provider, signer, contract;
    let timerInterval, blockchainInterval;
    let softTarget = 0, hardTarget = 0;

    async function connectWallet() {
        if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            
            document.getElementById("connectBtn").innerText = "âœ… " + addr.substring(0,6) + "...";
            contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

            const owner = await contract.owner();
            if (addr.toLowerCase() === owner.toLowerCase()) {
                document.getElementById("adminPanel").style.display = "block";
            }

            await updateData(addr);
            
            clearInterval(blockchainInterval);
            blockchainInterval = setInterval(() => updateData(addr), 5000); // 5ç§’æ›´æ–°éˆä¸Šæ•¸æ“š
            
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimers, 1000); // 1ç§’æ›´æ–°å€’æ•¸ UI

        } catch (e) { console.error(e); alert("é€£çµéŒ¯èª¤"); }
    }

    async function updateData(addr) {
        if(!contract) return;
        try {
            const hp = await contract.nianHp();
            document.getElementById("poolBalance").innerText = parseFloat(ethers.utils.formatEther(hp)).toFixed(4);

            const s = await contract.deadline();
            const h = await contract.hardDeadline();
            softTarget = s.toNumber();
            hardTarget = h.toNumber();

            const last = await contract.lastAttacker();
            document.getElementById("lastAttacker").innerText = 
                (last === "0x0000000000000000000000000000000000000000") ? "---" : last.substring(0,6) + "...";

            const pend = await contract.getPendingDividend(addr);
            document.getElementById("myDividends").innerText = parseFloat(ethers.utils.formatEther(pend)).toFixed(5);
            
            const pData = await contract.players(addr);
            document.getElementById("myShares").innerText = parseFloat(ethers.utils.formatEther(pData[0])).toFixed(3);

            const bal = await provider.getBalance(addr);
            document.getElementById("myWallet").innerText = parseFloat(ethers.utils.formatEther(bal)).toFixed(4);

            // æª¢æŸ¥æ˜¯å¦çµæŸ
            const isOver = await contract.isGameOver();
            const now = Math.floor(Date.now()/1000);
            const timeUp = (now >= softTarget || now >= hardTarget);
            
            const settleBtn = document.getElementById("settleBtn");
            if (!isOver && timeUp && hp.gt(0)) {
                settleBtn.style.display = "block";
            } else {
                settleBtn.style.display = "none";
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ (é‡è¦ï¼šæ±ºå®šçµ‚å±€ UI)
            updateButtonLayout(now);

        } catch(e) { console.error(e); }
    }

    function updateTimers() {
        const now = Math.floor(Date.now() / 1000);
        
        // è»Ÿå€’æ•¸
        if (softTarget > 0) {
            const diff = softTarget - now;
            document.getElementById("softTimer").innerText = formatTime(diff);
            document.getElementById("softTimer").style.color = diff <= 300 ? "#FF0000" : "#FFF";
        }
        
        // ç¡¬å€’æ•¸
        if (hardTarget > 0) {
            const diff = hardTarget - now;
            document.getElementById("hardTimer").innerText = formatTime(diff);
            // æœ¬åœ°ä¹Ÿè·‘ä¸€æ¬¡ UI æ›´æ–°ï¼Œç¢ºä¿ç§’æ•¸åˆ‡æ›æ™‚æŒ‰éˆ•å³æ™‚åæ‡‰
            updateButtonLayout(now); 
        }
    }

    // ğŸ”¥ æ ¸å¿ƒ UI é‚è¼¯ï¼šè™•ç†çµ‚å±€æ¨¡å¼çš„æŒ‰éˆ•é¡¯ç¤ºèˆ‡éš±è—
    function updateButtonLayout(now) {
        if (hardTarget === 0) return;
        const diff = hardTarget - now; // è·é›¢é–‹å·¥é‚„æœ‰å¤šä¹…

        const btn0001 = document.getElementById("btn_0001");
        const btn001 = document.getElementById("btn_001"); // ä¸»è§’
        const btn01 = document.getElementById("btn_01");
        const btn1 = document.getElementById("btn_1");
        
        const grid = document.getElementById("attackGrid");
        const bossCard = document.getElementById("bossCard");
        const badge = document.getElementById("endgameBadge");
        const desc001 = document.getElementById("desc_001");

        // åˆ¤æ–·æ˜¯å¦é€²å…¥ 6 å¤©å…§çš„çµ‚å±€æ¨¡å¼
        // 6 days = 518400 seconds
        if (diff <= 518400) {
            // === çµ‚å±€æ¨¡å¼ ===
            
            // 1. éš±è—å…¶ä»–æŒ‰éˆ•
            btn0001.style.display = "none";
            btn01.style.display = "none";
            btn1.style.display = "none";

            // 2. æ”¹è®Šä½ˆå±€ç‚ºå–®æ¬„
            grid.classList.add("single-mode");

            // 3. å¼·åŒ– 0.01 æŒ‰éˆ•æ¨£å¼
            btn001.classList.add("special-mode");

            // 4. é–‹å•Ÿç‰¹æ•ˆ
            bossCard.classList.add("endgame-mode");
            badge.style.display = "block";

            // 5. æ›´æ–°æ–‡å­—èªªæ˜
            if (diff <= 3600) {
                desc001.innerText = "ğŸš¨ æœ€å¾Œä¸€å°æ™‚ï¼šé‡ç½® 60 ç§’";
                badge.innerText = "ğŸ§¨ çµ‚å±€ï¼š60 ç§’æ¥µé€Ÿæˆ°";
            } else if (diff <= 86400) {
                desc001.innerText = "âš¡ æœ€å¾Œä¸€å¤©ï¼šé‡ç½® 5 åˆ†é˜";
                badge.innerText = "ğŸ§¨ çµ‚å±€ï¼š5 åˆ†é˜æ­»é¬¥";
            } else if (diff <= 259200) { // 3 days
                desc001.innerText = "âš ï¸ æœ€å¾Œ 3 å¤©ï¼šé‡ç½® 10 åˆ†é˜";
                badge.innerText = "ğŸ§¨ çµ‚å±€ï¼š10 åˆ†é˜æˆ°";
            } else if (diff <= 432000) { // 5 days
                desc001.innerText = "âš ï¸ æœ€å¾Œ 5 å¤©ï¼šé‡ç½® 15 åˆ†é˜";
                badge.innerText = "ğŸ§¨ çµ‚å±€ï¼š15 åˆ†é˜æˆ°";
            } else { // 6 days
                desc001.innerText = "âš ï¸ æœ€å¾Œ 6 å¤©ï¼šé‡ç½® 20 åˆ†é˜";
                badge.innerText = "ğŸ§¨ çµ‚å±€ï¼š20 åˆ†é˜æˆ°";
            }

        } else {
            // === å¹³æ™‚æ¨¡å¼ ===
            
            // æ¢å¾©é¡¯ç¤º
            btn0001.style.display = "flex";
            btn01.style.display = "flex";
            btn1.style.display = "flex";
            
            grid.classList.remove("single-mode");
            btn001.classList.remove("special-mode");
            bossCard.classList.remove("endgame-mode");
            badge.style.display = "none";
            
            desc001.innerText = "é‡ç½® 30 åˆ†é˜";
        }
    }

    function formatTime(s) {
        if (s <= 0) return "00:00:00";
        const d = Math.floor(s / 86400);
        const h = Math.floor((s % 86400) / 3600).toString().padStart(2,'0');
        const m = Math.floor((s % 3600) / 60).toString().padStart(2,'0');
        const sec = (s % 60).toString().padStart(2,'0');
        return (d>0) ? `${d}å¤© ${h}:${m}:${sec}` : `${h}:${m}:${sec}`;
    }

    async function attack(amt) {
        if(!contract) return;
        try {
            const tx = await contract.attack({ value: ethers.utils.parseEther(amt) });
            await tx.wait();
            updateData(await signer.getAddress());
        } catch(e) { alert("æ”»æ“Šå¤±æ•—ï¼š" + (e.data?.message || e.message)); }
    }
    async function claim() { try{(await contract.claimDividend()).wait(); alert("æˆåŠŸ");}catch(e){alert("å¤±æ•—");} }
    async function settleGame() { try{(await contract.settleGame()).wait(); alert("çµç®—å®Œæˆ");}catch(e){alert("å¤±æ•—");} }
    async function triggerFuse() { if(confirm("ç¢ºå®š?")) try{(await contract.triggerFuse()).wait(); alert("ç†”æ–·æˆåŠŸ");}catch(e){alert("å¤±æ•—");} }

    function openModal() { document.getElementById("rulesModal").style.display = "block"; }
    function closeModal() { document.getElementById("rulesModal").style.display = "none"; }
    window.onclick = (e) => { if(e.target == document.getElementById("rulesModal")) closeModal(); }
</script>

</body>
</html>

