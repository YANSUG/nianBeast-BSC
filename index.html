<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§¨ ç ²è½Ÿå¹´ç¸ï¼šå›åˆåˆ¶æ±ºæˆ°</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #FFD700; --red: #ff3b3b; --bg: #1a0505; --glass: rgba(20, 0, 0, 0.85); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); background-image: radial-gradient(circle at top, #4a0000 0%, #000 80%); color: #eee; font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 69, 0, 0.3); padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 26px; color: var(--gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .subtitle { font-size: 12px; color: #aaa; margin-top: 5px; }
        .rules-btn { background: rgba(255,215,0,0.1); border: 1px solid var(--gold); color: var(--gold); padding: 4px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; margin-top: 10px; }
        
        .boss-card { background: linear-gradient(145deg, #2b0000, #1a0000); border: 1px solid var(--gold); border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; position: relative; overflow: hidden; }
        .boss-card.endgame { border-color: var(--red); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        .endgame-tag { position: absolute; top: 0; right: 0; background: var(--red); color: white; font-size: 10px; padding: 4px 8px; border-bottom-left-radius: 8px; display: none; font-weight: bold; }
        
        .pool-label { font-size: 12px; color: #aaa; text-transform: uppercase; }
        .pool-amount { font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700; color: #fff; margin: 5px 0 15px 0; }
        
        .timer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .timer-box { background: rgba(0,0,0,0.4); border-radius: 8px; padding: 8px; }
        .t-label { font-size: 10px; opacity: 0.8; display: block; }
        .t-val { font-family: 'Roboto Mono', monospace; font-size: 16px; font-weight: bold; }
        .last-hit { font-size: 12px; background: rgba(255,255,255,0.05); padding: 6px; border-radius: 12px; color: #ccc; }
        
        .attack-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .attack-grid.single-mode { grid-template-columns: 1fr; }
        .atk-btn { background: linear-gradient(180deg, #3d3d3d, #222); border: 1px solid #555; color: #fff; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-height: 80px; justify-content: center; }
        .atk-btn:active { transform: scale(0.96); }
        .atk-btn.special { background: linear-gradient(135deg, #8B0000 0%, #400000 100%); border: 2px solid var(--gold); }
        .atk-btn .cost { font-size: 18px; font-weight: bold; font-family: 'Roboto Mono'; }
        .atk-btn .desc { font-size: 11px; margin-top: 4px; color: #aaa; }
        
        .stats-panel { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #bbb; }
        .claim-btn { width: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); border: none; padding: 12px; border-radius: 25px; color: #4a0000; font-weight: bold; cursor: pointer; }
        
        #settleBtn { width: 100%; background: #00E676; color: #000; font-weight: bold; padding: 15px; border: none; border-radius: 12px; margin-bottom: 20px; cursor: pointer; display: none; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        #connectBtn { width: 100%; background: #333; color: #fff; border: 1px solid #666; padding: 12px; border-radius: 30px; cursor: pointer; }
        
        .history-section { margin-top: 25px; border-top: 1px dashed #444; padding-top: 15px; }
        .hist-item { display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.3); margin-bottom: 6px; border-radius: 6px; font-size: 12px; }
        .hist-item.hard { border-left: 3px solid #ff0000; }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .modal-content { background: #1a1a1a; margin: 15% auto; padding: 25px; width: 85%; max-width: 400px; border-radius: 15px; border: 1px solid var(--gold); }
        .close { float: right; font-size: 24px; cursor: pointer; }
        
        #adminPanel { display: none; margin-top: 20px; text-align: center; }
        .fuse-btn { background: #500; color: #fff; border: 1px solid red; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ§¨ ç ²è½Ÿå¹´ç¸ V13.2</h1>
        <div class="subtitle">æ“Šæ®ºæ¶ 80% â€¢ åˆäº”åˆ†ç´…åŒ… â€¢ å›åˆåˆ¶è‚¡ä»½</div>
        <button class="rules-btn" onclick="document.getElementById('rulesModal').style.display='block'">ğŸ“œ è¦å‰‡èªªæ˜</button>
    </header>
    <div class="boss-card" id="bossCard">
        <div class="endgame-tag" id="endgameTag">ğŸ§§ çµ‚å±€æ¨¡å¼</div>
        <div class="pool-label">ç•¶å‰çæ±  (Round <span id="roundId">#1</span>)</div>
        <div class="pool-amount"><span id="poolBalance">---</span> BNB</div>
        <div class="timer-grid">
            <div class="timer-box" style="border:1px solid #ff5555; color:#ff5555">
                <span class="t-label">ğŸ”¥ æˆ°é¬¥å€’æ•¸</span><span class="t-val" id="softTimer">--:--:--</span>
            </div>
            <div class="timer-box" style="border:1px solid #00FFFF; color:#00FFFF">
                <span class="t-label">ğŸ“… å¼·åˆ¶é–‹å·¥</span><span class="t-val" id="hardTimer">--:--:--</span>
            </div>
        </div>
        <div class="last-hit">âš”ï¸ ä¸Šä¸€ä½å‹‡è€…: <span id="lastAttacker" style="color:#00FFFF; font-weight:bold">---</span></div>
    </div>
    <div class="attack-grid" id="attackGrid">
        <button class="atk-btn" id="btn_0001" onclick="attack('0.001')"><span class="cost">0.001 BNB</span><span class="desc">é‡ç½® 1 å°æ™‚</span></button>
        <button class="atk-btn" id="btn_001" onclick="attack('0.01')"><span class="cost">0.01 BNB</span><span class="desc" id="desc_001">é‡ç½® 30 åˆ†é˜</span></button>
        <button class="atk-btn" id="btn_01" onclick="attack('0.1')"><span class="cost">0.1 BNB</span><span class="desc">é‡ç½® 15 åˆ†é˜</span></button>
        <button class="atk-btn" id="btn_1" onclick="attack('1')"><span class="cost">1 BNB</span><span class="desc">é‡ç½® 5 åˆ†é˜</span></button>
    </div>
    <button id="settleBtn" onclick="settleGame()">ğŸ† æ™‚é–“åˆ°ï¼é»æ“Šç™¼ç</button>
    <div class="stats-panel">
        <div class="stat-row"><span>ğŸ‘› éŒ¢åŒ…é¤˜é¡</span><span style="color:var(--gold)" id="myWallet">---</span></div>
        <div class="stat-row"><span>ğŸ’° æœ¬å±€è‚¡ä»½</span><span style="color:var(--gold)" id="myShares">0.000</span></div>
        <div class="stat-row"><span>ğŸ’ å¾…é ˜åˆ†ç´…</span><span style="color:#00FF00; font-weight:bold" id="myDividends">0.0000</span></div>
        <button class="claim-btn" onclick="claim()">é ˜å–åˆ†ç´… (Claim)</button>
    </div>
    <button id="connectBtn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ…</button>
    <div class="history-section">
        <div style="color:var(--gold); margin-bottom:10px; font-size:14px; display:flex; justify-content:space-between">
            <span>ğŸ† æ­·ä»£åäººå ‚</span><span style="cursor:pointer" onclick="updateHistory()">ğŸ”„</span>
        </div>
        <div id="historyList" style="max-height:150px; overflow-y:auto; text-align:center; color:#666">è¼‰å…¥ä¸­...</div>
    </div>
    <div id="adminPanel"><button class="fuse-btn" onclick="triggerFuse()">â˜ ï¸ å•Ÿå‹•ä¿éšªçµ²</button></div>
</div>

<div id="rulesModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('rulesModal').style.display='none'">&times;</span>
        <h3 style="color:var(--gold); margin-top:0;">ğŸ“œ éŠæˆ²è¦å‰‡</h3>
        <p style="font-size:13px; line-height:1.6">1. <b>æ¶å°¾åˆ€</b>ï¼šå€’æ•¸æ­¸é›¶æ™‚ï¼Œæœ€å¾Œæ”»æ“Šè€…å¾— 80% çæ± ã€‚<br>2. <b>é–‹å·¥ç´…åŒ…</b>ï¼šè¾²æ›†åˆäº”å¼·åˆ¶çµç®—ï¼Œè§¸ç™¼ 60% å…¨ç¶²åˆ†ç´…ã€‚<br>3. <b>çµ‚å±€æ¨¡å¼</b>ï¼šå€’æ•¸ 6 å¤©å…§æ”»æ“Šæ™‚é–“ç¸®çŸ­ã€‚</p>
    </div>
</div>

<script>
    const CONTRACT_ADDR = "0x7A427604Ff8Ce728A60cF5cB247B30C0cE29188B";
    const ABI = [
        "function attack() external payable", "function settleGame() external", "function claimDividend() external", "function triggerFuse() external",
        "function nianHp() view returns (uint256)", "function lastAttacker() view returns (address)", "function getPendingDividend(address) view returns (uint256)",
        "function players(address) view returns (uint112, uint112, uint32)", "function isGameOver() view returns (bool)", "function owner() view returns (address)",
        "function deadline() view returns (uint64)", "function hardDeadline() view returns (uint64)", "function currentRoundId() view returns (uint64)",
        "function getHistoryPage(uint256 cursor, uint256 size) view returns (tuple(uint64 roundId, uint64 timestamp, address winner, uint256 winAmount, bool isHardWin)[])"
    ];
    let provider, signer, contract, timerInterval, dataInterval, softTarget=0, hardTarget=0;

    async function connectWallet() {
        if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            document.getElementById("connectBtn").innerText = "âœ… " + addr.substring(0,6) + "...";
            contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
            
            contract.owner().then(o => { if(addr.toLowerCase()===o.toLowerCase()) document.getElementById("adminPanel").style.display="block"; });
            
            updateAll();
            clearInterval(timerInterval); timerInterval = setInterval(updateTimers, 1000);
            clearInterval(dataInterval); dataInterval = setInterval(()=>updateData(addr), 5000);
        } catch(e) { alert("é€£çµå¤±æ•—"); }
    }

    async function updateAll() { const addr=await signer.getAddress(); updateData(addr); updateHistory(); }

    async function updateData(addr) {
        if(!contract) return;
        try {
            const [hp, sTime, hTime, last, pend, pData, bal, isOver, rId] = await Promise.all([
                contract.nianHp(), contract.deadline(), contract.hardDeadline(), contract.lastAttacker(),
                contract.getPendingDividend(addr), contract.players(addr), provider.getBalance(addr), contract.isGameOver(), contract.currentRoundId()
            ]);
            document.getElementById("poolBalance").innerText = parseFloat(ethers.utils.formatEther(hp)).toFixed(4);
            softTarget = sTime.toNumber(); hardTarget = hTime.toNumber();
            document.getElementById("roundId").innerText = "#" + rId;
            document.getElementById("lastAttacker").innerText = (last.substring(0,2)==="0x" && last.length>10) ? last.substring(0,6)+"..." : "---";
            document.getElementById("myDividends").innerText = parseFloat(ethers.utils.formatEther(pend)).toFixed(5);
            document.getElementById("myShares").innerText = parseFloat(ethers.utils.formatEther(pData[0])).toFixed(3);
            document.getElementById("myWallet").innerText = parseFloat(ethers.utils.formatEther(bal)).toFixed(4);
            
            const now = Math.floor(Date.now()/1000);
            const timeUp = (now >= softTarget || now >= hardTarget);
            document.getElementById("settleBtn").style.display = (!isOver && timeUp && hp.gt(0)) ? "block" : "none";
            updateUI(now);
        } catch(e) {}
    }

    function updateTimers() {
        const now = Math.floor(Date.now()/1000);
        if(softTarget > 0) {
            const diff = softTarget - now;
            const el = document.getElementById("softTimer");
            el.innerText = formatTime(diff);
            el.parentElement.style.borderColor = diff<=300 ? "#ff3b3b" : "#ff5555";
        }
        if(hardTarget > 0) {
            document.getElementById("hardTimer").innerText = formatTime(hardTarget - now);
            updateUI(now);
        }
    }

    function updateUI(now) {
        if(hardTarget===0) return;
        const diff = hardTarget - now;
        const grid = document.getElementById("attackGrid");
        const btn001 = document.getElementById("btn_001");
        const isEndgame = (diff <= 518400 && diff > 0);
        
        if(isEndgame) {
            grid.classList.add("single-mode");
            document.getElementById("btn_0001").style.display="none";
            document.getElementById("btn_01").style.display="none";
            document.getElementById("btn_1").style.display="none";
            btn001.classList.add("special");
            document.getElementById("bossCard").classList.add("endgame");
            document.getElementById("endgameTag").style.display="block";
            
            let txt = "é‡ç½® 20 åˆ†é˜";
            if(diff<=3600) txt="é‡ç½® 60 ç§’"; else if(diff<=86400) txt="é‡ç½® 5 åˆ†é˜"; else if(diff<=259200) txt="é‡ç½® 10 åˆ†é˜"; else if(diff<=432000) txt="é‡ç½® 15 åˆ†é˜";
            document.getElementById("desc_001").innerText = txt;
        } else {
            grid.classList.remove("single-mode");
            document.getElementById("btn_0001").style.display="flex";
            document.getElementById("btn_01").style.display="flex";
            document.getElementById("btn_1").style.display="flex";
            btn001.classList.remove("special");
            document.getElementById("bossCard").classList.remove("endgame");
            document.getElementById("endgameTag").style.display="none";
            document.getElementById("desc_001").innerText = "é‡ç½® 30 åˆ†é˜";
        }
    }

    async function updateHistory() {
        if(!contract) return;
        try {
            const list = await contract.getHistoryPage(0, 10);
            let html = "";
            if(list.length===0) html="<div style='padding:10px'>æš«ç„¡ç´€éŒ„</div>";
            list.forEach(i => {
                const isHard = i.isHardWin;
                const amt = parseFloat(ethers.utils.formatEther(i.winAmount)).toFixed(4);
                const addr = i.winner.substring(0,6)+"...";
                html += `<div class="hist-item ${isHard?'hard':''}"><div><span style="color:#aaa">#${i.roundId}</span> <span style="color:${isHard?'#f55':'#ccc'}">${isHard?'ç´…åŒ…':'æ“Šæ®º'}</span></div><div style="text-align:right"><span style="color:#0FF; font-family:monospace">${addr}</span> â€¢ <span style="color:#FD0">${amt}</span></div></div>`;
            });
            document.getElementById("historyList").innerHTML = html;
        } catch(e){}
    }

    function formatTime(s) {
        if(s<=0) return "00:00:00";
        const d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60;
        return d>0 ? `${d}å¤© ${h}:${m}:${sec}` : `${h}:${m}:${sec}`;
    }

    async function attack(amt) {
        if(!contract) return;
        try {
            const tx = await contract.attack({value:ethers.utils.parseEther(amt)});
            await tx.wait(); updateAll();
        } catch(e) { alert("å¤±æ•—: "+(e.data?.message||e.message)); }
    }
    async function claim() { try{(await contract.claimDividend()).wait(); alert("æˆåŠŸ"); updateAll();}catch(e){alert("å¤±æ•—");} }
    async function settleGame() { try{(await contract.settleGame()).wait(); alert("çµç®—å®Œæˆ"); updateAll();}catch(e){alert("å¤±æ•—");} }
    async function triggerFuse() { if(confirm("ç¢ºå®š?")) try{(await contract.triggerFuse()).wait(); alert("å·²ç†”æ–·");}catch(e){alert("å¤±æ•—");} }
</script>
</body>
</html>






