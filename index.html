<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¨ ç ²è½Ÿå¹´ç¸ï¼šæ±ºæˆ°åˆäº” ğŸ§¨</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
    <style>
        body {
            background-color: #2b0000;
            background-image: radial-gradient(circle at center, #500000 0%, #1a0000 100%);
            color: #FFD700;
            font-family: 'Microsoft JhengHei', sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #FF4500;
            box-shadow: 0 0 50px rgba(255, 69, 0, 0.4);
            position: relative;
        }
        h1 { margin-top: 0; text-shadow: 0 0 10px #FF4500; font-size: 32px; }
        
        /* è¦å‰‡æŒ‰éˆ• */
        .rules-btn-top {
            background: transparent; border: 1px solid #FFD700; color: #FFD700;
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 14px;
            margin-bottom: 15px; transition: all 0.2s;
        }
        .rules-btn-top:hover { background: rgba(255, 215, 0, 0.2); }

        .boss-section {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #330000 0%, #800000 50%, #330000 100%);
            background-size: cover;
            border-radius: 15px;
            border: 2px solid #FFD700;
            position: relative;
            min-height: 200px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }
        .boss-hp {
            font-size: 40px; font-weight: bold; color: #FFF;
            text-shadow: 0 0 20px #FF0000, 0 0 10px #FF0000;
            margin: 10px 0;
        }
        .hp-label { font-size: 16px; color: #FFD700; margin-bottom: 5px; }
        
        .timers-container {
            display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px;
        }
        .timer-box {
            background: #000; color: #FF0000; font-family: monospace;
            font-size: 20px; padding: 10px 15px; border-radius: 10px;
            border: 1px solid #FF0000; min-width: 200px;
        }
        .timer-label { font-size: 12px; color: #aaa; margin-bottom: 2px; display: block; }
        .hard-timer { border-color: #00FFFF; color: #00FFFF; }

        .attack-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0;
        }
        .atk-btn {
            background: linear-gradient(180deg, #ff6b6b, #c0392b);
            border: 2px solid #fff; color: white; padding: 15px;
            border-radius: 15px; cursor: pointer; transition: transform 0.1s;
            display: flex; flex-direction: column; align-items: center;
        }
        .atk-btn:active { transform: scale(0.95); }
        .atk-btn:hover { box-shadow: 0 0 15px #ff6b6b; border-color: #FFD700; }
        .atk-cost { font-size: 20px; font-weight: bold; }
        .atk-desc { font-size: 12px; margin-top: 5px; color: #eee; }

        .dividend-panel {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            padding: 15px; border-radius: 15px;
            margin-top: 20px;
        }
        .claim-btn {
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border: none; padding: 10px 20px; color: #500000; font-weight: bold;
            border-radius: 30px; cursor: pointer; margin-top: 10px; font-size: 16px;
        }
        .claim-btn:hover { transform: scale(1.05); box-shadow: 0 0 10px #FFD700; }
        
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #ccc; }
        .highlight { color: #00FF00; font-weight: bold; }
        .winner-addr { color: #00FFFF; font-family: monospace; font-weight: bold;}

        .admin-panel {
            margin-top: 40px; padding: 15px; border: 1px dashed #FF4444; border-radius: 10px;
            display: none; background: rgba(50, 0, 0, 0.5);
        }
        .fuse-btn {
            background: #800000; color: #fff; border: 1px solid red;
            padding: 8px 15px; cursor: pointer; border-radius: 5px; margin-top: 10px;
        }
        .fuse-btn:hover { background: red; }

        #connectBtn {
            background: linear-gradient(90deg, #333, #555); color: white;
            border: 1px solid #aaa; padding: 10px 25px; border-radius: 50px;
            cursor: pointer; font-size: 16px; margin-top: 20px;
        }
        #connectBtn:hover { border-color: #fff; }

        /* --- Modal å½ˆçª—æ¨£å¼ --- */
        .modal {
            display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #300000; border: 2px solid #FFD700; margin: 10% auto; padding: 25px;
            width: 85%; max-width: 500px; border-radius: 15px; text-align: left;
            box-shadow: 0 0 30px #FFD700; max-height: 80vh; overflow-y: auto; color: #eee;
        }
        .close-btn { float: right; font-size: 32px; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #fff; }
        .rules-title { color: #FFD700; border-bottom: 1px dashed #555; padding-bottom: 10px; margin-top: 0; text-align: center; }
        .rule-item { margin-bottom: 15px; line-height: 1.6; font-size: 15px; }
        .rule-icon { color: #FF4500; font-weight: bold; font-size: 18px; margin-right: 5px; }

    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§¨ ç ²è½Ÿå¹´ç¸ï¼šæ±ºæˆ°åˆäº”</h1>
    <button class="rules-btn-top" onclick="openRules()">ğŸ“œ æŸ¥çœ‹éŠæˆ²è¦å‰‡</button>
    
    <p style="color:#aaa; font-size:14px; line-height: 1.6;">
        é›†å…¨ç¶²ä¹‹åŠ›æ“Šæ®ºå¹´ç¸ï¼<br>
        æœ€å¾Œä¸€æ“Šç¨å¾— <span style="color:#FFD700">80%</span> çæ± ï¼Œå…¶é¤˜ <span style="color:#00FF00">20%</span> ä¿ç•™ç‚ºä¸‹è¼ªåº•æ± ï¼
    </p>

    <div class="boss-section">
        <div class="hp-label">ğŸ‘¹ å¹´ç¸è¡€é‡ (ç´¯ç©çæ± )</div>
        <div class="boss-hp"><span id="poolBalance">0.0000</span> BNB</div>
        
        <div class="timers-container">
            <div class="timer-box">
                <span class="timer-label">ğŸ”¥ æˆ°é¬¥å€’æ•¸ (é‡ç½®å‹)</span>
                <span id="softTimer">--:--:--</span>
            </div>
            <div class="timer-box hard-timer">
                <span class="timer-label">ğŸ“… å¼·åˆ¶é–‹å·¥ (å›ºå®š)</span>
                <span id="hardTimer">--:--:--</span>
            </div>
        </div>
        
        <div style="margin-top:15px; font-size:14px; background:rgba(0,0,0,0.6); padding:5px 10px; border-radius:20px;">
            âš”ï¸ ç›®å‰è´å®¶ (Last Hit): <span id="lastAttacker" class="winner-addr">ç­‰å¾…å‹‡è€…...</span>
        </div>
    </div>

    <div class="attack-grid">
        <button class="atk-btn" onclick="attack('0.001')">
            <div class="atk-cost">ğŸ§¨ 0.001 BNB</div>
            <div class="atk-desc">é‡ç½®ç‚º 1 å°æ™‚</div>
        </button>
        <button class="atk-btn" onclick="attack('0.01')">
            <div class="atk-cost">ğŸ’£ 0.01 BNB</div>
            <div class="atk-desc">é‡ç½®ç‚º 30 åˆ†é˜</div>
        </button>
        <button class="atk-btn" onclick="attack('0.1')">
            <div class="atk-cost">ğŸš€ 0.1 BNB</div>
            <div class="atk-desc">é‡ç½®ç‚º 15 åˆ†é˜</div>
        </button>
        <button class="atk-btn" onclick="attack('1')">
            <div class="atk-cost">â˜¢ï¸ 1 BNB</div>
            <div class="atk-desc">é‡ç½®ç‚º 5 åˆ†é˜ (æ¥µé€Ÿ)</div>
        </button>
    </div>

    <div class="dividend-panel">
        <div class="info-row">
            <span>ğŸ‘› æˆ‘çš„éŒ¢åŒ…é¤˜é¡:</span>
            <span class="highlight" id="myWalletBalance">--- BNB</span>
        </div>
        <div style="border-bottom: 1px dashed #555; margin: 10px 0;"></div>
        <div class="info-row">
            <span>ğŸ’° æˆ‘çš„ç´¯ç©ä»½é¡ (Shares):</span>
            <span class="highlight" id="myShares">0 BNB</span>
        </div>
        <div class="info-row">
            <span>ğŸ’ ç•¶å‰å¯é ˜åˆ†ç´…:</span>
            <span class="highlight" id="myDividends">0.0000 BNB</span>
        </div>
        <button class="claim-btn" onclick="claim()">ğŸ¤‘ é ˜å–åˆ†ç´… (Claim)</button>
    </div>

    <div id="settleArea" style="margin-top:20px; display:none;">
        <button onclick="settleGame()" style="background:#00AA00; color:white; border:2px solid #00FF00; padding:15px 30px; font-weight:bold; cursor:pointer; font-size:18px; border-radius:10px; box-shadow:0 0 15px #00FF00;">
            ğŸ† æ™‚é–“åˆ°ï¼é»æ“Šçµç®—ç™¼ç (é–‹å•Ÿä¸‹ä¸€å¹´)
        </button>
    </div>

    <button id="connectBtn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ…</button>

    <div id="adminPanel" class="admin-panel">
        <div style="color:#FF4444; font-weight:bold; margin-bottom:10px;">ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶å°</div>
        <button class="fuse-btn" onclick="triggerFuse()">â˜ ï¸ å•Ÿå‹•ä¿éšªçµ² (å¼·åˆ¶ç†”æ–·)</button>
    </div>
</div>

<div id="rulesModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeRules()">&times;</span>
        <h2 class="rules-title">ğŸ“œ è¨ä¼å¹´ç¸æ”»ç•¥</h2>
        
        <div class="rule-item">
            <span class="rule-icon">âš”ï¸</span> <strong>æ ¸å¿ƒç©æ³• (æ¶å°¾åˆ€)</strong><br>
            ç•¶ã€Œæˆ°é¬¥å€’æ•¸ã€æ­¸é›¶ï¼Œæˆ–ã€Œå¼·åˆ¶é–‹å·¥ã€æ™‚é–“åˆ°é”æ™‚ï¼Œ<span style="color:#FFD700">æœ€å¾Œä¸€ä½æ”»æ“Šè€…</span> è¦–ç‚ºæ“Šæ®ºå¹´ç¸ï¼Œç¨å¾— <span style="color:#FFD700">80%</span> å¤§çæ± ï¼
        </div>

        <div class="rule-item">
            <span class="rule-icon">ğŸ’°</span> <strong>è³‡é‡‘æµå‘</strong><br>
            æ‚¨çš„æ”»æ“Šé‡‘é¡åˆ†é…ï¼š
            <ul>
                <li><strong>80%</strong>ï¼šé€²å…¥å¹´ç¸è¡€é‡ (ç´¯ç©çæ± )ã€‚</li>
                <li><strong>20%</strong>ï¼šå…¨ç¶²åˆ†ç´… (æŒ‰ä»½é¡åˆ†é…çµ¦æ‰€æœ‰ç©å®¶)ã€‚</li>
            </ul>
        </div>

        <div class="rule-item">
            <span class="rule-icon">â³</span> <strong>æ™‚é–“é‡ç½®æ©Ÿåˆ¶</strong><br>
            æ”»æ“Šé‡‘é¡è¶Šé«˜ï¼Œå€’æ•¸æ™‚é–“è¶ŠçŸ­ (æˆ°å±€è¶Šåˆºæ¿€)ï¼š<br>
            ğŸ§¨ 0.001 BNB &rarr; é‡ç½®ç‚º 1 å°æ™‚<br>
            ğŸ’£ 0.01 BNB &rarr; é‡ç½®ç‚º 30 åˆ†é˜<br>
            ğŸš€ 0.1 BNB &rarr; é‡ç½®ç‚º 15 åˆ†é˜<br>
            â˜¢ï¸ 1.0 BNB &rarr; é‡ç½®ç‚º 5 åˆ†é˜
        </div>

        <div class="rule-item">
            <span class="rule-icon">ğŸ“…</span> <strong>å¼·åˆ¶é–‹å·¥æ—¥</strong><br>
            ç„¡è«–æˆ°æ³å¦‚ä½•ï¼Œæ¯å¹´ <span style="color:#00FFFF">è¾²æ›†åˆäº”ä¸­åˆ 12:00</span> å¼·åˆ¶çµç®—ã€‚ç•¶ä¸‹çš„æœ€å¾Œæ”»æ“Šè€…ç²å‹ï¼ŒéŠæˆ²è‡ªå‹•é€²å…¥ä¸‹ä¸€å¹´ã€‚
        </div>

        <div class="rule-item" style="color:#aaa; font-size:12px; border-top:1px solid #555; padding-top:10px;">
            * çµç®—å¾Œï¼Œçæ± çš„ 20% å°‡ä¿ç•™ç‚ºä¸‹ä¸€å¹´çš„åº•æ± ã€‚<br>
            * éŠæˆ²å…§å»º 12 å¹´è‡ªå‹•è¼ªè¿´æ©Ÿåˆ¶ï¼Œæ°¸çºŒé‹ä½œã€‚
        </div>
    </div>
</div>

<script>
    const NIAN_ADDRESS = "0x049f1f2F1399BAE97B2576CA70A8EEF148a7d5B8";
    
    const ABI = [
        "function attack() external payable",
        "function settleGame() external",
        "function claimDividend() external",
        "function triggerFuse() external",
        "function nianHp() view returns (uint256)",
        "function lastAttacker() view returns (address)",
        "function getPendingDividend(address) view returns (uint256)",
        "function players(address) view returns (uint256, uint256, uint256)",
        "function isGameOver() view returns (bool)",
        "function owner() view returns (address)",
        "function deadline() view returns (uint256)",
        "function hardDeadline() view returns (uint256)"
    ];

    let provider, signer, contract;
    let blockchainTimer;
    let localTicker;
    
    let targetSoftDeadline = 0;
    let targetHardDeadline = 0;

    async function connectWallet() {
        if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            
            document.getElementById("connectBtn").innerText = "âœ… å·²é€£çµ: " + addr.substring(0,6) + "...";
            document.getElementById("connectBtn").disabled = true;
            
            contract = new ethers.Contract(NIAN_ADDRESS, ABI, signer);
            
            const ownerAddr = await contract.owner();
            if (addr.toLowerCase() === ownerAddr.toLowerCase()) {
                document.getElementById("adminPanel").style.display = "block";
            }

            await updateBlockchainData(addr);
            
            if (blockchainTimer) clearInterval(blockchainTimer);
            blockchainTimer = setInterval(() => updateBlockchainData(addr), 5000);

            if (localTicker) clearInterval(localTicker);
            localTicker = setInterval(updateLocalTimers, 1000);

        } catch (e) { console.error(e); alert("é€£çµå¤±æ•—: " + e.message); }
    }

    async function updateBlockchainData(addr) {
        if(!contract) return;
        try {
            const hp = await contract.nianHp();
            document.getElementById("poolBalance").innerText = parseFloat(ethers.utils.formatEther(hp)).toFixed(4);

            const softDL = await contract.deadline();
            const hardDL = await contract.hardDeadline();
            targetSoftDeadline = softDL.toNumber();
            targetHardDeadline = hardDL.toNumber();

            const last = await contract.lastAttacker();
            if (last === "0x0000000000000000000000000000000000000000") {
                document.getElementById("lastAttacker").innerText = "ç­‰å¾…é¦–ä½å‹‡è€…...";
            } else {
                document.getElementById("lastAttacker").innerText = last.substring(0,6) + "..." + last.substring(38);
            }

            const pending = await contract.getPendingDividend(addr);
            document.getElementById("myDividends").innerText = parseFloat(ethers.utils.formatEther(pending)).toFixed(6) + " BNB";
            
            const playerData = await contract.players(addr);
            document.getElementById("myShares").innerText = parseFloat(ethers.utils.formatEther(playerData[0])).toFixed(3) + " BNB";

            const balance = await provider.getBalance(addr);
            document.getElementById("myWalletBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4) + " BNB";

            const isOver = await contract.isGameOver();
            const now = Math.floor(Date.now() / 1000);
            const timeUp = (now >= targetSoftDeadline || now >= targetHardDeadline);
            
            if (!isOver && timeUp && hp.gt(0)) {
                document.getElementById("settleArea").style.display = "block";
            } else {
                document.getElementById("settleArea").style.display = "none";
            }

        } catch (e) { console.error("Update Error:", e); }
    }

    function updateLocalTimers() {
        const now = Math.floor(Date.now() / 1000);
        if (targetSoftDeadline > 0) {
            const diffSoft = targetSoftDeadline - now;
            document.getElementById("softTimer").innerText = formatTime(diffSoft);
            if(diffSoft <= 0) document.getElementById("softTimer").style.color = "#FF4444";
            else document.getElementById("softTimer").style.color = "#FF0000";
        }
        if (targetHardDeadline > 0) {
            const diffHard = targetHardDeadline - now;
            document.getElementById("hardTimer").innerText = formatTime(diffHard);
        }
    }

    function formatTime(seconds) {
        if (seconds <= 0) return "00:00:00";
        const d = Math.floor(seconds / (3600 * 24));
        const h = Math.floor((seconds % (3600 * 24)) / 3600).toString().padStart(2,'0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2,'0');
        const s = (seconds % 60).toString().padStart(2,'0');
        
        if (d > 0) return `${d}å¤© ${h}:${m}:${s}`;
        return `${h}:${m}:${s}`;
    }

    async function attack(bnbAmount) {
        if(!contract) return;
        try {
            const tx = await contract.attack({ value: ethers.utils.parseEther(bnbAmount) });
            document.getElementById("softTimer").innerText = "ç¢ºèªä¸­...";
            await tx.wait();
            updateBlockchainData(await signer.getAddress());
        } catch (e) {
            alert("æ”»æ“Šå¤±æ•—ï¼š" + (e.data?.message || e.message));
        }
    }

    async function claim() {
        if(!contract) return;
        try {
            const tx = await contract.claimDividend();
            await tx.wait();
            alert("ğŸ’° é ˜å–æˆåŠŸï¼");
            updateBlockchainData(await signer.getAddress());
        } catch (e) {
            alert("é ˜å–å¤±æ•—ï¼š" + (e.data?.message || e.message));
        }
    }

    async function settleGame() {
        if(!contract) return;
        try {
            const tx = await contract.settleGame();
            await tx.wait();
            alert("ğŸ† éŠæˆ²çµç®—å®Œæˆï¼æ–°çš„ä¸€å¹´é–‹å§‹äº†ï¼");
            updateBlockchainData(await signer.getAddress());
        } catch (e) {
            alert("çµç®—å¤±æ•—ï¼š" + (e.data?.message || e.message));
        }
    }

    async function triggerFuse() {
        if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æ°¸ä¹…çµæŸéŠæˆ²ä¸¦å›æ”¶è³‡é‡‘ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
        try {
            const tx = await contract.triggerFuse();
            await tx.wait();
            alert("ğŸ”’ ä¿éšªçµ²å·²å•Ÿå‹•ã€‚");
        } catch (e) {
            alert("ç†”æ–·å¤±æ•—ï¼š" + (e.data?.message || e.message));
        }
    }

    // Modal Control
    function openRules() { document.getElementById("rulesModal").style.display = "block"; }
    function closeRules() { document.getElementById("rulesModal").style.display = "none"; }
    window.onclick = function(event) {
        if (event.target == document.getElementById("rulesModal")) {
            closeRules();
        }
    }
</script>

</body>
</html>

